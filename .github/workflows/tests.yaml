name: Tests

on:
  workflow_dispatch: #  Allows manual triggers
  push:
    branches:
      - main
    paths:
      - "**.py"
      - "**.pyi"
      - "**/requirements*.txt"
      - "**/pyproject.toml"
      - ".github/workflows/typecheck.yaml"
  pull_request:
    branches:
      - main
    paths:
      - "**.py"
      - "**.pyi"
      - "**/requirements*.txt"
      - "**/pyproject.toml"
      - ".github/workflows/typecheck.yaml"

env:
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  FORCE_COLOR: 1

jobs:
  pyright:
    name: Run pyright
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: pip install typing_extensions
      - name: Get pyright version
        id: pyright_version
        run: |
          PYRIGHT_VERSION=$(grep pyright== 'Dolphin scripts/requirements-dev.txt' | cut -d "#" -f 1 | cut -d \; -f 1 | cut -d = -f 3)
          echo pyright version: "${PYRIGHT_VERSION}"
          echo PYRIGHT_VERSION="${PYRIGHT_VERSION}" >> "${GITHUB_OUTPUT}"
      - uses: jakebailey/pyright-action@v2
        with:
          version: ${{ steps.pyright_version.outputs.PYRIGHT_VERSION }}

  verify_newsfragments:
    name: Verify Newsfragments
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: python .github/verify_newsfragments.py
      - run: python -m pip install towncrier
      # - run: python -m towncrier check
      - run: python -m towncrier build --draft --version check
